name: CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write

jobs:
  trivy_fs:
    name: Security - Trivy (repo)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  backend:
    name: Backend - unit + integration tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven
      - name: Backend tests
        working-directory: backend
        run: mvn -B clean test

  frontend:
    name: Frontend - tests + build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package.json
      - name: Install, test, build
        working-directory: frontend
        run: |
          npm install --no-audit --no-fund
          npm run test
          npm run build

  codeql:
    name: Security - CodeQL (SAST)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ["java", "javascript"]
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - uses: github/codeql-action/analyze@v3

  dependency_check:
    name: Security - Dependency Check (backend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@v3
        with:
          project: "projet-indiv-backend"
          path: "./backend"
          format: "HTML"
          out: "dependency-check-report"
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report

  dast_and_load:
    name: DAST (ZAP) + Load (k6)
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Start stack (docker compose)
        run: |
          docker compose up -d --build
          docker compose ps

      - name: Wait backend health
        run: |
          set -e
          for i in $(seq 1 40); do
            if curl -fsS "http://localhost:8080/actuator/health" >/dev/null; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting backend... ($i/40)"
            sleep 2
          done
          echo "Backend not ready"
          exit 1

      - name: ZAP baseline (DAST) on frontend
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: "http://localhost:3000"
          fail_action: false

      - name: k6 smoke
        run: docker run --rm --network host -v "$PWD:/src" grafana/k6 run /src/tests/load/k6-smoke.js

      - name: k6 spike
        run: docker run --rm --network host -v "$PWD:/src" grafana/k6 run /src/tests/load/k6-spike.js

      - name: Shutdown stack
        if: always()
        run: docker compose down -v
